<!DOCTYPE html>
<html lang="cs" xmlns="http://www.w3.org/1999/html">

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.2.6/vue.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://kit.fontawesome.com/1e8b9b6262.js" crossOrigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">

    <title>Démona - kalkulačka zranění</title>
</head>

<style>
    td:has(input),
    td:has(select),
    td:has(.card),
    th:has(input) {
        padding: 0.1rem 0.2rem 0.1rem 0;
    }

    input {
        margin-bottom: 0px;
    }
</style>

<body>
<div id="vuaApp" class="container">
    <h1>D&D - Kalkulačka průměrného zranění</h1>
    <p>Tato kalkulačka je obecně použitelná pro výpočet průměrného zranění zbraně podle pravidel D&D.</p>
    <h2>Příklad výpočtu</h2>
    <p>
        Na příkladu v tabulkách dole je předvypočtené zranění postavičky, která používá kukri. Kukri má základní rozsah
        zranění "1d6", rozsah kritického zranění má "18-20" a násobitel kritického zranění má "x2", tedy
        ve světě D&D píšeme, že má kritický "18-20/x2". </p>
    <p>Dále na kukri máme zranění ohněm v rozsahu "1d8" a naše postavička
        má Sílu 14, což znamená že modifikátor Síly je +2 - toto je ke zranění přidáno rovněž.
        Naše postavička má navíc Feat Improved Critical pro Kukri, který zvyšuje kritický na "15-20/x2".
    </p>
    <p>
        Vidíme, že vypočtené tzv. "Základní průměrné zranění" vyjde 10. Jedná se o součet všech zranění pokud
        by nám ani jednou nepadlo kritické zranění.
        </p>
    <p>
        V tabulce níž už vidíme "Celkové průměrné zranění", které nás zajímá nejvíc, neboť zahrnuje kritický útok.
        To představuje průměrné zranění, které bychom udíleli s každým zásahem do slámeného panáka s
        AC = 0 (obranným číslem).
    </p>
    <p>
        Nakonec je zde tabula "Reálné průměrné zranění za kolo", která představuje rálnou situaci, kdy útočíme do
        nepřátelské postavicky, která má nějaké AC. Do této se někdy strefíme a někdy ne, podle toho, jaký máme
        AB.
    </p>
    <table>
        <h3><b>Základní</b> průměrné zranění</h3>
        <thead>
        <tr>
            <th>
                Rozsah zranění <i class="fa-regular fa-circle-question"
                                  title='Napište přesně např. "1-8" pokud má zranění rozsah, nebo napiště přesně např. "5" pokud je zranění fixní'></i>
            </th>
            <th>
                Průměrné zranění <i class="fa-regular fa-circle-question"
                                    title='Pokud jste zadali hodnotu např. "1-8" potom průměrné zranění je rovno 4.5'></i>
            </th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="inputDamage, index in inputDamages" :key="index">
            <td>
                <input type="text" v-model="inputDamages[index]">
            </td>
            <td>
                {{calculateAverageDamage(inputDamage)}}
            </td>
        </tr>
        </tbody>
        <tfoot>
        <tr>
            <th>Celkem</th>
            <th>{{getTotalAverageDamage()}}</th>
        </tr>
        </tfoot>
    </table>

    <h3><b>Celkové</b> průměrné zranění (po započtení kritického úderu)</h3>
    <table>
        <thead>
        <tr>
            <th>Rozsah </br> kritického <i class="fa-regular fa-circle-question"
                                           title='Např. kukri bez featu Imrpoved Critical má rozsah "18-20"'></i>
            </th>
            <th>
                - 20 / x
            </th>
            <th>Násobitel </br> kritického
                <i class="fa-regular fa-circle-question"
                   title='Např. kukri má "x2"'></i>
            </th>
            <th>
                Šance na </br>kritický [%]
                <i class="fa-regular fa-circle-question"
                   title='Kolik procent úderů bude mít v průměru kritický.'></i>
            </th>
            <th>
                Zvýšení základního </br>  kritického zranění [%] <i class="fa-regular fa-circle-question"
                                                                    title='Např. kritický pro kukri "18-20/x2" zvedne základní průměrné zranění o 15%.'></i>
            </th>
            <th>
                <b>Celkové</b>                 </br> průměrné zranění
            </th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>
                <input type="number" v-model="criticalRange">
            </td>
            <td>
                - 20 / x
            </td>
            <td>
                <input type="number" v-model="criticalMultipl"></td>
            <td>
                {{calculateCriticalChance(criticalRange) * 100}} %
            </td>
            <td>
                {{roundNumber(calculateCriticalTotalDamageInceasePercent(criticalRange, criticalMultipl) * 100, 1) }} %
            </td>
            <th>
                <u>{{roundNumber(getTotalAverageCriticalDamage(), 1)}}</u>
            </th>
        </tr>
        </tbody>
    </table>

    <h3><b>Reálné</b> průměrné zranění za kolo</h3>
    <table>
        <thead>
            <th>AC Vašeho nepřítele</th>
        </thead>
        <tbody>
            <td><input type="number" v-model="oponentAc"></td>
        </tbody>
    </table>
    <table>
        <thead>
        <tr>
            <th>
                Útok </br>za kolo
                <i class="fa-regular fa-circle-question"
                   title='Např. bojovník s kukri a štítem bude mít celkem 4 útoky za kolo. Pokud bude největší AB mít 20, potom útoky budou mít AB 20, 15, 10, 5.
                   Monk ptočící pěstmi s aktivovaným featem "Flurry of Blows" bude mít útoků 7, a pokud bude mít 2 kamy bude to celkem útoků 9.'></i>
            </th>
            <th>
                AB</br>Vaši postavičky
            </th>
            <th>
                Šance </br>
                na zásah nepřítele
            </th>
            <th>
                Průměrné </br>
                zranění
            </th>
        </tr>
        </thead>
        <tbody>
            <tr v-for="inputAb, index in inputAbs" :key="index">
                <td>
                    {{index+1}}.
                </td>
                <td>
                    <input type="number" v-model="inputAbs[index]"/>
                </td>
                <td>
                    {{roundNumber(calculateChanceToHit(oponentAc, inputAbs[index]) * 100, 1)}} %
                </td>
                <td>
                    {{ roundNumber(getTotalAverageCriticalDamage() * calculateChanceToHit(oponentAc, inputAbs[index]), 1)}}
                </td>
            </tr>
        </tbody>
        <tfoot>
            <tr>
                <th colspan="3">
                    Celkové průměrné zranění z 1 kolo:
                </th>
                <th>
                    {{roundNumber(getTotalAverageDamagePerRoundToOponent(), 1)}}
                </th>
            </tr>
        </tfoot>
    </table>

    <h3>
        Shrnutí
    </h3>
    <p>
        Vaše postavička uděluje do sláměného panáka bez obrany v průměru celkem {{getTotalAverageCriticalDamage()}} bodů zranění.
        Do nepřátelské postavy s AC {{oponentAc}} uděluje za 1 kolo v průměru celkem {{getTotalAverageDamagePerRoundToOponent()}}
        bodů zranění.
    </p>

    <h3>Autor</h3>
    <p>
        Jurass17, postavičky na Démoně Ferda Lumpajs, Johny Trýzel, John Kukačka, a další :-)
    </p>
    <p>
        Email: kacirek.j@gmail.com
    </p>
    <p>
        Licence: Pokud budete dál šířit, nezapomeňtě uvést informace o autorovi. Pokud budete modifikovat a uvádět
        své jméno, nezapomeňte mě prosím taky. Děkuji.
    </p>
</div>

</div>

</body>

<script>
    let app = new Vue({
        el: '#vuaApp',
        data: {
            inputDamages: ["1-6", "1-8", "2", "", "", "", "", ""],
            inputAbs: [20,15,10,5,0,0,0,0,0],
            criticalRange: 15,
            criticalMultipl: 2,
            criticalChangePercent: 0,
            oponentAc: 30,
        },
        methods: {
            getTotalAverageCriticalDamage() {
                return this.getTotalAverageDamage() * (1 +
                    this.calculateCriticalTotalDamageInceasePercent(this.criticalRange, this.criticalMultipl))
            },
            calculateCriticalTotalDamageInceasePercent(criticalRange, criticalMultipl) {
                const chance = this.calculateCriticalChance(criticalRange);
                return ((1 - chance) + (chance * criticalMultipl)) - 1;
            },
            calculateCriticalChance(criticalRange) {
                return (20 - criticalRange + 1) / 20
            },
            calculateChanceToHit(oponentAc, attackerAb) {
                /**
                 * Scenario:
                 * 1. Attacker AB 20, Defender AC 30 -> 21,22,23,24,25,26,27,28,29 is miss, chance to hit is 55%
                 * 2. Attacker AB 20, Defender AC 20 -> 21 is miss, chance to hit is 95%
                 * 3. Attacker AB 20, Defender AC 40 -> all except 20 is miss, chance to hit is 5%
                 * 4. Attacker AB 20, Defender AC 90 -> all except 20 is miss, chance to hit is 5%
                 * 5. Attacker AB 20, Defender AC 10 -> 1 is miss, chance to to hit 95%
                 *
                 * Conclusion formulae:
                 *
                 * (20 - (AB - AC) + 1) / 20 = hit chance
                 * but boundaries : max hit chance is 95%, min hit chance is 5%
                 */
                if(attackerAb <= 0) {
                    return 0;
                }
                let hitChance = (20 - (oponentAc - attackerAb) + 1) / 20;
                hitChance = hitChance > 0.95 ? 0.95 : hitChance;
                hitChance = hitChance < 0.05 ? 0.05 : hitChance;
                return hitChance;
            },
            getTotalAverageDamagePerRoundToOponent() {
                const totalDamageWithCritical = this.getTotalAverageCriticalDamage();
                let sumOfDamagesPerRound = 0;
                for(let inpuptAb of this.inputAbs) {
                    const chanceToHit = this.calculateChanceToHit(this.oponentAc, inpuptAb);
                    const damage = totalDamageWithCritical * chanceToHit;
                    sumOfDamagesPerRound += damage;
                }
                return sumOfDamagesPerRound;
            },
            getTotalAverageDamage() {
                let sum = 0;
                for (damage of this.inputDamages) {
                    sum += this.calculateAverageDamage(damage);
                }
                return sum;
            },
            calculateAverageDamage(damageString) {
                console.log("called")
                if (!damageString) {
                    return 0;
                }
                if (!damageString.includes("-")) {
                    return Number(damageString);
                }
                const parts = damageString.split("-");
                const part0 = Number(parts[0]);
                const part1 = Number(parts[1]);

                return (part0 + part1) / 2;
            },
            roundNumber(number, digits) {
                return Math.round(number * 10*digits) / 10 * digits;
            }
        },
        async beforeMount() {
        },
    });


</script>

</body>
</html>